<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spamsnare Email View</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        color: #ffffff;
        min-height: 100vh;
      }

      /* Navbar */
      .navbar {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #333;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: 700;
      }

      .logo-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(45deg, #4a9eff, #00d4ff);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
      }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .back-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
      }

      .logout-btn {
        background: linear-gradient(45deg, #ff4757, #ff3742);
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .logout-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
      }

      /* Main Content */
      .container {
        max-width: 1000px;
        margin: 2rem auto;
        padding: 0 2rem;
      }

      .email-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
      }

      .email-header {
        padding: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .email-subject {
        font-size: 1.5rem;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 1rem;
        line-height: 1.4;
      }

      .email-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .meta-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .meta-label {
        font-size: 0.8rem;
        color: #888;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .meta-value {
        color: #4a9eff;
        font-weight: 500;
        word-break: break-all;
      }

      .email-id {
        font-family: monospace;
        background: rgba(74, 158, 255, 0.1);
        padding: 0.5rem;
        border-radius: 6px;
        border: 1px solid rgba(74, 158, 255, 0.2);
      }

      .action-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .action-btn {
        background: linear-gradient(45deg, #4a9eff, #00d4ff);
        border: none;
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(74, 158, 255, 0.3);
      }

      .action-btn.danger {
        background: linear-gradient(45deg, #ff4757, #ff3742);
      }

      .action-btn.danger:hover {
        box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3);
      }

      .action-btn.secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .action-btn.secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
      }

      /* Email Content */
      .email-content {
        padding: 2rem;
      }

      .content-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .tab-btn {
        background: none;
        border: none;
        color: #888;
        padding: 0.8rem 1.2rem;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
        border-bottom: 2px solid transparent;
      }

      .tab-btn.active {
        color: #4a9eff;
        border-bottom-color: #4a9eff;
      }

      .tab-btn:hover {
        color: #4a9eff;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .html-content {
        background: rgba(255, 255, 255, 0.95);
        color: #333;
        padding: 2rem;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        line-height: 1.6;
      }

      .html-content a {
        color: #4a9eff;
        text-decoration: none;
      }

      .html-content a:hover {
        text-decoration: underline;
      }

      .raw-content {
        background: rgba(0, 0, 0, 0.5);
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        font-family: monospace;
        font-size: 0.85rem;
        line-height: 1.4;
        color: #e0e0e0;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 500px;
        overflow-y: auto;
      }

      .loading {
        text-align: center;
        padding: 3rem;
        color: #888;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(74, 158, 255, 0.3);
        border-top: 3px solid #4a9eff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-state {
        background: rgba(255, 71, 87, 0.1);
        border: 1px solid rgba(255, 71, 87, 0.3);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        color: #ff4757;
        margin: 2rem 0;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .navbar {
          padding: 1rem;
          flex-direction: column;
          gap: 1rem;
        }

        .container {
          padding: 0 1rem;
        }

        .email-header {
          padding: 1.5rem;
        }

        .email-content {
          padding: 1.5rem;
        }

        .email-meta {
          grid-template-columns: 1fr;
        }

        .action-buttons {
          flex-direction: column;
        }

        .content-tabs {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar">
      <div class="logo">
        <div class="logo-icon">üõ°Ô∏è</div>
        <span>Spamsnare</span>
      </div>
      <div class="nav-actions">
        <a href="javascript:history.back()" class="back-btn">
          <span>‚Üê</span>
          Back to Inbox
        </a>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
      <div class="email-container" id="emailContainer">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>Loading email...</p>
        </div>
      </div>
    </div>

    <script>
      // Configuration
      const API_BASE_URL = "http://localhost:3000";

      // Get email and ID from URL parameters
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      const EMAIL_ID = getQueryParam("email") || "";
      const MESSAGE_ID = getQueryParam("id") || "";

      console.log(EMAIL_ID, MESSAGE_ID);

      // Global state
      let currentEmail = null;

      async function fetchEmail() {
        try {
          const response = await fetch(`${API_BASE_URL}/specific-email/`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              email: EMAIL_ID,
              id: MESSAGE_ID,
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error fetching email:", error);
          throw error;
        }
      }

      function extractEmailHeaders(rawData) {
        const headers = {};
        const lines = rawData.split("\r\n");

        for (const line of lines) {
          if (line.trim() === "") break; // End of headers

          const colonIndex = line.indexOf(":");
          if (colonIndex > 0) {
            const key = line.substring(0, colonIndex).trim();
            const value = line.substring(colonIndex + 1).trim();
            headers[key.toLowerCase()] = value;
          }
        }

        return headers;
      }

      function formatDate(dateString) {
        try {
          const date = new Date(dateString);
          return date.toLocaleString();
        } catch {
          return dateString;
        }
      }

      function renderEmail(emailData) {
        const container = document.getElementById("emailContainer");

        if (
          !emailData ||
          !emailData.data ||
          !emailData.data.data ||
          !emailData.data.data.message
        ) {
          container.innerHTML = `
            <div class="error-state">
              <h3>Email not found</h3>
              <p>The requested email could not be loaded.</p>
            </div>
          `;
          return;
        }

        const message = emailData.data.data.message;
        const headers = extractEmailHeaders(message.data);
        currentEmail = message;

        container.innerHTML = `
          <div class="email-header">
            <h1 class="email-subject">${escapeHtml(
              headers.subject || "No Subject"
            )}</h1>
            
            <div class="email-meta">
              <div class="meta-item">
                <div class="meta-label">From</div>
                <div class="meta-value">${escapeHtml(
                  headers.from || "Unknown"
                )}</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">To</div>
                <div class="meta-value">${escapeHtml(
                  headers.to || EMAIL_ID
                )}</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Date</div>
                <div class="meta-value">${formatDate(headers.date || "")}</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Message ID</div>
                <div class="meta-value email-id">${escapeHtml(message.id)}</div>
              </div>
            </div>

            <div class="action-buttons">
              <button class="action-btn" onclick="flagEmail()">
                <span>üö©</span>
                Flag Email
              </button>
              <button class="action-btn secondary" onclick="copyEmailId()">
                <span>üìã</span>
                Copy ID
              </button>
              <button class="action-btn secondary" onclick="downloadRaw()">
                <span>üíæ</span>
                Download Raw
              </button>
              <button class="action-btn danger" onclick="deleteEmail()">
                <span>üóëÔ∏è</span>
                Delete
              </button>
            </div>
          </div>

          <div class="email-content">
            <div class="content-tabs">
              <button class="tab-btn active" onclick="switchTab('html')">HTML Content</button>
              <button class="tab-btn" onclick="switchTab('raw')">Raw Data</button>
            </div>

            <div id="html-tab" class="tab-content active">
              <div class="html-content">
                ${message.html || "<p>No HTML content available</p>"}
              </div>
            </div>

            <div id="raw-tab" class="tab-content">
              <div class="raw-content">${escapeHtml(message.data)}</div>
            </div>
          </div>
        `;
      }

      function switchTab(tab) {
        // Remove active class from all tabs and content
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((content) => content.classList.remove("active"));

        // Add active class to selected tab
        event.target.classList.add("active");
        document.getElementById(tab + "-tab").classList.add("active");
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function flagEmail() {
        if (currentEmail) {
          alert(`Email flagged: ${currentEmail.id}`);
          // In a real application, you'd make an API call here
        }
      }

      function copyEmailId() {
        if (currentEmail) {
          navigator.clipboard
            .writeText(currentEmail.id)
            .then(() => {
              alert("Email ID copied to clipboard!");
            })
            .catch(() => {
              alert(`Email ID: ${currentEmail.id}`);
            });
        }
      }

      function downloadRaw() {
        if (currentEmail) {
          const blob = new Blob([currentEmail.data], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `email_${currentEmail.id}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
      }

      function deleteEmail() {
        if (
          currentEmail &&
          confirm("Are you sure you want to delete this email?")
        ) {
          alert(`Email deleted: ${currentEmail.id}`);
          // In a real application, you'd make an API call here
          // Then redirect back to inbox
          // window.location.href = 'inbox.html';
        }
      }

      function logout() {
        if (confirm("Are you sure you want to logout?")) {
          alert("Logged out successfully!");
          // window.location.href = '/login';
        }
      }

      // Initialize the email view when page loads
      document.addEventListener("DOMContentLoaded", async function () {
        if (!EMAIL_ID || !MESSAGE_ID) {
          document.getElementById("emailContainer").innerHTML = `
            <div class="error-state">
              <h3>Missing Parameters</h3>
              <p>Email ID and Message ID are required to view this email.</p>
            </div>
          `;
          return;
        }

        try {
          const emailData = await fetchEmail();
          renderEmail(emailData);
        } catch (error) {
          document.getElementById("emailContainer").innerHTML = `
            <div class="error-state">
              <h3>Error loading email</h3>
              <p>Failed to fetch email from the server.</p>
              <p style="font-size: 0.9rem; margin-top: 1rem;">Error: ${error.message}</p>
              <button onclick="location.reload()" style="margin-top: 1rem; background: #ff4757; border: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                Try Again
              </button>
            </div>
          `;
        }
      });

      // Sample data for testing when API is not available
      const SAMPLE_DATA = {
        email: "7d9b17bc-f44d-4940-b934-db4766a9832a@maildrop.cc",
        data: {
          data: {
            message: {
              id: "hZwfodhI0j",
              html: '<html>\r\nCongratulations!<br><br>\r\nIf you are reading this your email address is working.<br><br>\r\nThis is not spam or a solicitation. This email was sent to your email address because you, or someone else, requested a test email to be sent to this address. We work hard to ensure a balance between testing, transparency, and privacy. If you did not request this email test, it\'s likely that someone accidentally mistyped their email address as yours. You can request your email address be blocked here: <a href="https://sendtestemail.com/block">https://sendtestemail.com/block</a><br><br>\r\nThe IP address of the requester of this test email is: 117.213.18.91\r\n</html>',
              data: "Received: from mail.sendtestemail.com (mail.sendtestemail.com [143.244.187.129])\r\n        by maildrop\r\n        with SMTP (Maildrop) id MDVHHRWE\r\n        for 7d9b17bc-f44d-4940-b934-db4766a9832a@maildrop.cc;\r\n        Sun, 03 Aug 2025 09:33:36 +0000 (UTC)\r\nReceived: by mail.sendtestemail.com (Postfix, from userid 48)\r\n\tid 7442A30003F1; Sun,  3 Aug 2025 04:33:34 -0500 (CDT)\r\nTo: 7d9b17bc-f44d-4940-b934-db4766a9832a@maildrop.cc\r\nSubject: SendTestEmail.com - Testing Email ID: 04f4d6fa07d6043cdc3df7e051634472\r\nFrom: SendTestEmail <noreply@sendtestemail.com>\r\nMIME-Version: 1.0\r\nContent-Type: multipart/alternative;boundary=ste688f2cee6bee9\r\nList-Unsubscribe: <https://sendtestemail.com/block>\r\nMessage-Id: <20250803093334.7442A30003F1@mail.sendtestemail.com>\r\nDate: Sun,  3 Aug 2025 04:33:34 -0500 (CDT)",
            },
          },
        },
      };

      // Uncomment the line below to test with sample data instead of API
      // setTimeout(() => renderEmail(SAMPLE_DATA), 1000);
    </script>
  </body>
</html>
